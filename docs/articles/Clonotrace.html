<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="Clonotrace">
<title>An R Markdown document converted from "./vignettes/Clonotrace.ipynb" â€¢ Clonotrace</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="An R Markdown document converted from " .>
<meta property="og:description" content="Clonotrace">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">Clonotrace</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/Clonotrace.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>An R Markdown document converted from "./vignettes/Clonotrace.ipynb"</h1>
            
      
      
      <div class="d-none name"><code>Clonotrace.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>future.globals.maxSize <span class="op">=</span> <span class="fl">4</span> <span class="op">*</span> <span class="fl">1024</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: SeuratObject</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: sp</span></span></code></pre>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'SeuratObject'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dplyr'</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     filter, lag</span></span></code></pre>
<pre><code><span><span class="co">## The following objects are masked from 'package:base':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     intersect, setdiff, setequal, union</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://Matrix.R-forge.R-project.org" class="external-link">Matrix</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.apply.futureverse.org" class="external-link">future.apply</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">Clonotrace</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="data">data<a class="anchor" aria-label="anchor" href="#data"></a>
</h3>
<p>We first read in data. The demo data is from a public in vitro
longitudinal experiment to monitor the hematopoiesis (<a href="https://www.science.org/doi/10.1126/science.aaw3381" class="external-link uri">https://www.science.org/doi/10.1126/science.aaw3381</a>).
You can download the demo data from: <a href="https://upenn.box.com/s/9bxv50lueelrrf5zv4ked20dlkalrtir" class="external-link uri">https://upenn.box.com/s/9bxv50lueelrrf5zv4ked20dlkalrtir</a></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seurat_object</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">"../../hematopoiesis.rds"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pca</span> <span class="op">=</span> <span class="va">seurat_object</span><span class="op">@</span><span class="va">reductions</span><span class="op">$</span><span class="va">pca</span><span class="op">@</span><span class="va">cell.embeddings</span></span>
<span><span class="va">umap</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">seurat_object</span><span class="op">@</span><span class="va">reductions</span><span class="op">$</span><span class="va">umap</span><span class="op">@</span><span class="va">cell.embeddings</span><span class="op">)</span></span>
<span><span class="va">cell_meta</span> <span class="op">=</span> <span class="va">seurat_object</span><span class="op">@</span><span class="va">meta.data</span></span></code></pre></div>
<p>Within this data, there are 34782 cells are sampled at 3 time
points.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">cell_meta</span><span class="op">$</span><span class="va">Time.point</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##     2     4     6 </span></span>
<span><span class="co">##  3407 11101 20274</span></span></code></pre>
<p>This data has a simple cell type compistion with only 3 cell
types:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_type_umap</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="va">umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span>,color_by <span class="op">=</span> <span class="st">"Cell.type.annotation"</span>,size <span class="op">=</span> <span class="fl">0.1</span>,label_size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,  </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span></span>
<span><span class="va">cell_type_umap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>For a higher resolustion in the downstream analysis, we further
cluster cells into 9 cell clusters.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_cluster_umap</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="va">umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span>,color_by <span class="op">=</span> <span class="st">"cluster"</span>,size <span class="op">=</span> <span class="fl">0.1</span>,label_size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,  </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span></span>
<span><span class="va">cell_cluster_umap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="clone-label-spreading">clone label spreading<a class="anchor" aria-label="anchor" href="#clone-label-spreading"></a>
</h3>
<p>We first build a cell kNN graph based within the PCA space:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_knn</span> <span class="op">=</span> <span class="fu"><a href="../reference/embedding2knn.html">embedding2knn</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">pca</span><span class="op">)</span>,k <span class="op">=</span> <span class="fl">30</span>,mode <span class="op">=</span> <span class="st">"connectivity"</span>,if_self <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">cell_knn</span> <span class="op">=</span> <span class="fu"><a href="../reference/compute_transition.html">compute_transition</a></span><span class="op">(</span><span class="va">cell_knn</span><span class="op">)</span></span></code></pre></div>
<p>Here we define a clone as a population of cells which share the same
lineage barcode at the same time point. Based on this definition there
are 8108 clones in total. 802 out of them expanded over 10 cells.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_size</span> <span class="op">=</span> <span class="va">cell_meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">clone</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">expanded_clones</span> <span class="op">=</span> <span class="va">clone_size</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">count</span> <span class="op">&gt;=</span><span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_size_hist</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">clone_size</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span>,binwidth <span class="op">=</span> <span class="fl">1</span>,color <span class="op">=</span> <span class="st">"black"</span>,fill <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,linetype <span class="op">=</span> <span class="st">"dashed"</span>,color <span class="op">=</span> <span class="st">"coral"</span>,linewidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"sqrt(clone size)"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"clone count"</span><span class="op">)</span></span>
<span><span class="va">clone_size_hist</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>Then we could spread the clone label in the cell graph to smooth the
cell density in those expanding clones. There is a bootstrap during this
process to filter out propogation with high deviance, usually in regions
with high density of lowly expanded or unexpanded clones. So itâ€™s better
to run this in parallel.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_clone</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>cell <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_meta</span><span class="op">)</span>,clone <span class="op">=</span> <span class="va">cell_meta</span><span class="op">[</span>,<span class="st">"clone"</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>clone <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">clone</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">expanded_clones</span><span class="op">$</span><span class="va">clone</span>, <span class="va">clone</span>, <span class="cn">NA_character_</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>,workers <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">clone_labels</span> <span class="op">=</span> <span class="fu"><a href="../reference/label_spreading_bootstrap.html">label_spreading_bootstrap</a></span><span class="op">(</span>adj <span class="op">=</span> <span class="va">cell_knn</span>,labels <span class="op">=</span> <span class="va">cell_clone</span><span class="op">$</span><span class="va">clone</span>,</span>
<span>                                              alpha <span class="op">=</span> <span class="fl">0.6</span>, sample_rate <span class="op">=</span> <span class="fl">0.8</span>,sample_n <span class="op">=</span> <span class="fl">48</span><span class="op">)</span></span>
<span><span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">end</span><span class="op">-</span><span class="va">start</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Time difference of 12.64555 mins</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_clone_prob_raw</span> <span class="op">=</span> <span class="va">clone_labels</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">deviance</span> <span class="op">=</span> <span class="va">clone_labels</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_clone_prob_raw</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_meta</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">deviance_hist</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">deviance</span><span class="op">)</span>,fill <span class="op">=</span> <span class="st">"coral"</span>,color <span class="op">=</span> <span class="st">"black"</span>,binwidth <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fl">0.3</span>,linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"cell count"</span><span class="op">)</span></span>
<span><span class="va">deviance_hist</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<p>We can visualize the deviance of clone label spreading in each cell
via cell UMAP, and here we use the 0.3 as the upper bound threshold for
deviance. Cells with high deviance are enriched in undifferentiated
cells, which due to they havenâ€™t proliferated enough to expand their
clones.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_meta</span><span class="op">$</span><span class="va">deviance</span> <span class="op">=</span> <span class="va">deviance</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">deviance_umap</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span><span class="va">umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">deviance</span> <span class="op">&gt;</span> <span class="fl">0.3</span><span class="op">)</span>,color_by <span class="op">=</span> <span class="st">"deviance"</span>,label <span class="op">=</span> <span class="cn">FALSE</span>,size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"deviance"</span>,option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,  </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Cells with high deviance"</span><span class="op">)</span></span>
<span><span class="va">deviance_umap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>Then we filter out cells with high deviance, and sparsify the
cell-to-clone probablity by keeping top 90% mass</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_clone_prob_raw</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_meta</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_clone_prob</span> <span class="op">=</span> <span class="va">cell_clone_prob_raw</span><span class="op">[</span><span class="va">deviance</span> <span class="op">&lt;</span> <span class="fl">0.3</span>,<span class="op">]</span></span>
<span><span class="va">cell_clone_prob</span> <span class="op">=</span> <span class="va">cell_clone_prob</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_clone_prob</span> <span class="op">=</span> <span class="fu"><a href="../reference/mat_sparsify.html">mat_sparsify</a></span><span class="op">(</span>mat <span class="op">=</span> <span class="va">cell_clone_prob</span>,row_mass <span class="op">=</span> <span class="fl">0.9</span>,col_mass <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span>
<span><span class="va">cell_clone_prob</span> <span class="op">=</span> <span class="va">cell_clone_prob</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span></span>
<span><span class="va">cell_clone_prob</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/Matrix.html" class="external-link">Matrix</a></span><span class="op">(</span><span class="va">cell_clone_prob</span>, sparse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">cell_clone</span><span class="op">$</span><span class="va">clone</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can use an example to show how the cell clone assignment is
smoothed during this process:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_clone</span> <span class="op">=</span> <span class="st">"Lineage-1193-6"</span></span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_example_umap_raw</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span><span class="va">umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">clone</span> <span class="op">==</span> <span class="va">example_clone</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>group <span class="op">=</span> <span class="st">"1"</span><span class="op">)</span>,</span>
<span>                                 color_by <span class="op">=</span> <span class="st">"group"</span>,label <span class="op">=</span> <span class="cn">FALSE</span>,size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,    </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">clone_example_umap_raw</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-24-1.png" width="700"></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_meta</span><span class="op">$</span><span class="va">prob</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">cell_meta</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span>,<span class="op">]</span><span class="op">$</span><span class="va">prob</span> <span class="op">=</span> <span class="va">cell_clone_prob</span><span class="op">[</span>,<span class="va">example_clone</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">umap</span><span class="op">$</span><span class="va">prob</span> <span class="op">=</span> <span class="va">cell_meta</span><span class="op">$</span><span class="va">prob</span></span></code></pre></div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_example_umap_smooth</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">umap_1</span>,y <span class="op">=</span> <span class="va">umap_2</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">umap</span>,color <span class="op">=</span> <span class="st">"lightgrey"</span>,size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">umap</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">prob</span> <span class="op">&gt;</span> <span class="fl">0.025</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">prob</span><span class="op">)</span>,</span>
<span>           <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="va">prob</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">2</span>,alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"prob"</span>,option <span class="op">=</span> <span class="st">"turbo"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,   </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clone_example_umap_smooth</span> <span class="op">=</span> <span class="fu">ggrastr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrastr/man/rasterize.html" class="external-link">rasterize</a></span><span class="op">(</span><span class="va">clone_example_umap_smooth</span>,layers<span class="op">=</span><span class="st">'Point'</span>, dpi<span class="op">=</span><span class="fl">300</span><span class="op">)</span></span>
<span><span class="va">clone_example_umap_smooth</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="clonewise-transcriptomic-distance">Clonewise transcriptomic distance<a class="anchor" aria-label="anchor" href="#clonewise-transcriptomic-distance"></a>
</h3>
<p>After we smooth the cell density for each expanded clone over the
cell transcriptomic embedding, we can measure their cell distribution
difference via optimal transportation distance.</p>
<p>We provide two methods for this, the first one calculate the exact
optimal transportation distance, and the second one is a faster
approximation, but less accurate. You can switch the modes by the
<code>exact</code> parameter in the <code>clone_disance</code>
function.</p>
<p>This step is time and memory consuming, which can take hours even
with the approximation. We strongly recommend to put this step in a
server or cluster and run it with multiple cores. (As a reference, the
approximation method takes 40 minutes to run on the HPC paralleled with
4 cores using 8 Gb RAM).</p>
<p>Here for time efficiency, we can use the pre-computed clone-wise
distance for downstream applicaitons.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"clone_graph_dis.rds"</span>, package <span class="op">=</span> <span class="st">"Clonotrace"</span><span class="op">)</span></span>
<span><span class="va">clone_dis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="va">file_path</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="clone-embedding-visualization">clone embedding visualization<a class="anchor" aria-label="anchor" href="#clone-embedding-visualization"></a>
</h3>
<p>We first cluster clones using leiden algorithm and visualize the
clone community in the UMAP.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1230</span><span class="op">)</span></span>
<span><span class="va">clone_cluster</span> <span class="op">=</span> <span class="fu"><a href="../reference/leiden_dis.html">leiden_dis</a></span><span class="op">(</span>dismat <span class="op">=</span> <span class="va">clone_dis</span>,k <span class="op">=</span> <span class="fl">20</span>,resolution <span class="op">=</span> <span class="fl">0.5</span>,if_umap <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Found more than one class "dist" in cache; using the first, from namespace 'spam'</span></span></code></pre>
<pre><code><span><span class="co">## Also defined by 'BiocGenerics'</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_cluster_center</span> <span class="op">=</span> <span class="va">clone_cluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_all</a></span><span class="op">(</span><span class="va">median</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_cluster</span><span class="op">$</span><span class="va">mass</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Matrix/man/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_leiden_umap</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">umap1</span>,y <span class="op">=</span> <span class="va">umap2</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clone_cluster</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">cluster</span>,size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span><span class="op">)</span>,pch<span class="op">=</span><span class="fl">21</span>,color <span class="op">=</span> <span class="st">"black"</span>,alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_label_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clone_cluster_center</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,   </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span></span>
<span><span class="va">clone_leiden_umap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<p>We can also visualize the clone embedding in other low dimension
reduction like diffusion map:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_leiden_dm</span> <span class="op">&lt;-</span> <span class="fu">diffusionMap</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/diffusionMap/man/diffuse.html" class="external-link">diffuse</a></span><span class="op">(</span><span class="va">clone_dis</span>,maxdim <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Performing eigendecomposition</span></span>
<span><span class="co">## Computing Diffusion Coordinates</span></span>
<span><span class="co">## Used default value: 11 dimensions</span></span>
<span><span class="co">## Elapsed time: 2.063 seconds</span></span></code></pre>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_leiden_dm_coord</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">clone_leiden_dm</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">clone_leiden_dm_coord</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"dm"</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">clone_leiden_dm_coord</span><span class="op">)</span>,sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">clone_leiden_dm_coord</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">clone_cluster</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dm_cluster_center</span> <span class="op">=</span> <span class="va">clone_leiden_dm_coord</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">clone_cluster</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html" class="external-link">summarise_all</a></span><span class="op">(</span><span class="va">median</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">dm_cluster_center</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="st">"cluster"</span></span></code></pre></div>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_leiden_diffmap</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dm1</span>,y <span class="op">=</span> <span class="va">dm2</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clone_leiden_dm_coord</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clone_cluster</span><span class="op">$</span><span class="va">cluster</span>,size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">clone_cluster</span><span class="op">$</span><span class="va">mass</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           pch<span class="op">=</span><span class="fl">21</span>,color <span class="op">=</span> <span class="st">"black"</span>,alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html" class="external-link">geom_label_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dm_cluster_center</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,    <span class="co"># Remove axis numbers (labels)</span></span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"none"</span>,size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"log2(mass)"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"dm 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"dm 2"</span><span class="op">)</span></span>
<span><span class="va">clone_leiden_diffmap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-34-1.png" width="700"></p>
<p>Diffusion map is good to layout continous movement of clones over
time.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_cluster</span> <span class="op">=</span> <span class="va">clone_cluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>clone <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">clone_cluster</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>lineage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">clone</span>,start <span class="op">=</span> <span class="fl">1</span>,stop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">clone</span><span class="op">)</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>                                  time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">clone</span>,start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">clone</span><span class="op">)</span>,stop <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">clone</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>                                  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"day"</span>,<span class="va">time</span>,sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_link</span> <span class="op">=</span> <span class="fu"><a href="../reference/long2wide.html">long2wide</a></span><span class="op">(</span><span class="va">clone_cluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lineage</span>,<span class="va">time</span>,<span class="va">clone</span><span class="op">)</span>,</span>
<span>                       row_names_from <span class="op">=</span> <span class="st">"lineage"</span>,</span>
<span>                       col_names_from <span class="op">=</span> <span class="st">"time"</span>,</span>
<span>                       values_from <span class="op">=</span> <span class="st">"clone"</span>,</span>
<span>                       symmetric <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">clone_link</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">clone_link</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">clone_link</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_link_coord</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">clone_link</span>,</span>
<span>                         <span class="va">clone_leiden_dm_coord</span><span class="op">[</span><span class="va">clone_link</span><span class="op">$</span><span class="va">start</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dm1"</span>,<span class="st">"dm2"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                         <span class="va">clone_leiden_dm_coord</span><span class="op">[</span><span class="va">clone_link</span><span class="op">$</span><span class="va">end</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dm1"</span>,<span class="st">"dm2"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                         <span class="va">clone_cluster</span><span class="op">[</span><span class="va">clone_link</span><span class="op">$</span><span class="va">start</span>,<span class="st">"cluster"</span><span class="op">]</span>,</span>
<span>                         <span class="va">clone_cluster</span><span class="op">[</span><span class="va">clone_link</span><span class="op">$</span><span class="va">end</span>,<span class="st">"cluster"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">clone_link_coord</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"start"</span>,<span class="st">"end"</span>,<span class="st">"xdm1"</span>,<span class="st">"xdm2"</span>,<span class="st">"ydm1"</span>,<span class="st">"ydm2"</span>,<span class="st">"x_cluster"</span>,<span class="st">"y_cluster"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sub_annot</span> <span class="op">=</span> <span class="va">clone_cluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lineage</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">clone_link_coord</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sub_dm_coord</span> <span class="op">=</span> <span class="va">clone_leiden_dm_coord</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sub_annot</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_leiden_diffmap_arrow</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clone_leiden_dm_coord</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dm1</span>,y <span class="op">=</span> <span class="va">dm2</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">0.2</span>,color <span class="op">=</span> <span class="st">"lightgrey"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sub_dm_coord</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dm1</span>,y <span class="op">=</span> <span class="va">dm2</span>,fill <span class="op">=</span> <span class="va">sub_annot</span><span class="op">$</span><span class="va">time</span>,size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">sub_annot</span><span class="op">$</span><span class="va">mass</span><span class="op">)</span><span class="op">)</span>,shape <span class="op">=</span> <span class="fl">21</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clone_link_coord</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">xdm1</span>,y <span class="op">=</span> <span class="va">xdm2</span>,xend <span class="op">=</span> <span class="va">ydm1</span>,yend <span class="op">=</span> <span class="va">ydm2</span><span class="op">)</span>,</span>
<span>             arrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/arrow.html" class="external-link">arrow</a></span><span class="op">(</span>length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.03</span>, <span class="st">"npc"</span><span class="op">)</span><span class="op">)</span>,linewidth <span class="op">=</span> <span class="fl">0.25</span>,alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_d</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,    <span class="co"># Remove axis numbers (labels)</span></span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>       size <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"log2(mass)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clone_leiden_diffmap_arrow</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="profile-projection-in-cell-embedding">profile projection in cell embedding<a class="anchor" aria-label="anchor" href="#profile-projection-in-cell-embedding"></a>
</h3>
<p>After we cluster the clones into profiles, with the cell clone
probabilty, we can also map cells to profiles:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_profile</span> <span class="op">=</span> <span class="va">clone_cluster</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">clone</span>,<span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>flag <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">clone_profile</span> <span class="op">=</span> <span class="fu"><a href="../reference/long2sparse.html">long2sparse</a></span><span class="op">(</span>long <span class="op">=</span> <span class="va">clone_profile</span>,row_names_from <span class="op">=</span> <span class="st">"clone"</span>,col_names_from <span class="op">=</span> <span class="st">"cluster"</span>,values_from <span class="op">=</span> <span class="st">"flag"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_profile_prob</span> <span class="op">=</span> <span class="va">cell_clone_prob</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">clone_profile</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_profile_prob</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span></span></code></pre></div>
<p>For cells with profile probability higher than 0.5, we assign it with
a profile label:</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_meta</span><span class="op">$</span><span class="va">profile</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">cell_meta</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_profile_prob</span><span class="op">)</span>,<span class="op">]</span><span class="op">$</span><span class="va">profile</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">cell_profile_prob</span>,<span class="fl">1</span>,<span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.5</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">else</span><span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="va">cell_meta</span> <span class="op">=</span> <span class="va">cell_meta</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">profile</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_meta</span><span class="op">$</span><span class="va">profile_prob</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">cell_meta</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_profile_prob</span><span class="op">)</span>,<span class="op">]</span><span class="op">$</span><span class="va">profile_prob</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">cell_profile_prob</span>,<span class="fl">1</span>,<span class="va">max</span><span class="op">)</span></span></code></pre></div>
<p>Then we can visualize how profile flow over the cell embedding:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_profile_umap</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="va">umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span>,color_by <span class="op">=</span> <span class="st">"profile"</span>,</span>
<span>                            size <span class="op">=</span> <span class="fl">0.1</span>,alpha_by <span class="op">=</span> <span class="st">"profile_prob"</span>,label <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="st">"none"</span>,color <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cell_profile_umap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-45-1.png" width="700"></p>
<p>Obvisouly, profile 5 and 6 monopotently differentiate to monocytes
and profile 3 and 7 monopotently differentiate to netriphil, while
profile 1 and 4 denote the bipotent differenitation.</p>
</div>
<div class="section level3">
<h3 id="clone-level-pseudotime">Clone level pseudotime<a class="anchor" aria-label="anchor" href="#clone-level-pseudotime"></a>
</h3>
<p>We first generate the clone level pseudotime by diffusion pseudotime
in the clone embedding. Here we use the clone distance projection in the
MDS space as the clone embedding.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_mds</span> <span class="op">=</span> <span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/isoMDS.html" class="external-link">isoMDS</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">clone_dis</span><span class="op">)</span>, k<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## initial  value 6.673968 </span></span>
<span><span class="co">## iter   5 value 3.757695</span></span>
<span><span class="co">## iter  10 value 2.922664</span></span>
<span><span class="co">## iter  15 value 2.544110</span></span>
<span><span class="co">## iter  20 value 2.367482</span></span>
<span><span class="co">## iter  25 value 2.291132</span></span>
<span><span class="co">## iter  30 value 2.251516</span></span>
<span><span class="co">## iter  35 value 2.225022</span></span>
<span><span class="co">## iter  40 value 2.207040</span></span>
<span><span class="co">## final  value 2.194391 </span></span>
<span><span class="co">## converged</span></span></code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_embedding</span> <span class="op">=</span> <span class="va">clone_mds</span><span class="op">$</span><span class="va">points</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">clone_embedding</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"mds"</span>,<span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">clone_embedding</span><span class="op">)</span>,sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">clone_embedding</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">clone_cluster</span><span class="op">)</span></span></code></pre></div>
<p>This step is kind slow, here we also read a pre-computed MDS
embedding for the downstream analysis:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"clone_mds.tsv"</span>, package <span class="op">=</span> <span class="st">"Clonotrace"</span><span class="op">)</span></span>
<span><span class="va">clone_embedding</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span><span class="va">file_path</span>,sep <span class="op">=</span> <span class="st">"\t"</span>,header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Here we choose the cell cluster 0 as the starting cluster for
diffusion pseudotime. The <code>clone_dpt</code> function would
automatically choose the clone which has the highest enrichment in this
starting cluster to be the root of diffusion pseudotime.</p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_t</span> <span class="op">=</span> <span class="fu"><a href="../reference/clone_dpt.html">clone_dpt</a></span><span class="op">(</span>clone_embedding <span class="op">=</span> <span class="va">clone_embedding</span>,cell_meta <span class="op">=</span> <span class="va">cell_meta</span>,</span>
<span>                    clone_col <span class="op">=</span> <span class="st">"clone"</span>,cluster_col <span class="op">=</span> <span class="st">"cluster"</span>,start_cluster <span class="op">=</span> <span class="st">"0"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_cluster</span><span class="op">$</span><span class="va">dpt</span> <span class="op">=</span> <span class="va">clone_t</span></span></code></pre></div>
<p>We can then visualize the clone level pseudotime in the diffusion
map:</p>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clone_dpt_diffmap</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dm1</span>,y <span class="op">=</span> <span class="va">dm2</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">clone_leiden_dm_coord</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">clone_cluster</span><span class="op">$</span><span class="va">dpt</span>,size <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log2</a></span><span class="op">(</span><span class="va">clone_cluster</span><span class="op">$</span><span class="va">mass</span><span class="op">)</span><span class="op">)</span>,</span>
<span>           pch<span class="op">=</span><span class="fl">21</span>,color <span class="op">=</span> <span class="st">"black"</span>,alpha <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,    <span class="co"># Remove axis numbers (labels)</span></span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"clone t"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html" class="external-link">guides</a></span><span class="op">(</span>size <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"dm 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"dm 2"</span><span class="op">)</span></span>
<span><span class="va">clone_dpt_diffmap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-51-1.png" width="700"></p>
<p>Then we can smooth the clone level pseudotime over the cell embedding
by multiplying the clone pseudotime to cell clone probability. The
pseudotime inference is necessary for the fate driving gene detection in
the downstream analysis.</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_meta</span><span class="op">$</span><span class="va">cell_t</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">cell_meta</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span>,<span class="op">]</span><span class="op">$</span><span class="va">cell_t</span> <span class="op">=</span> <span class="va">cell_clone_prob</span><span class="op">[</span>,<span class="va">clone_cluster</span><span class="op">$</span><span class="va">clone</span><span class="op">]</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">clone_cluster</span><span class="op">$</span><span class="va">dpt</span></span></code></pre></div>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_dpt_umap</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="va">umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span>,color_by <span class="op">=</span> <span class="st">"cell_t"</span>,</span>
<span>                            size <span class="op">=</span> <span class="fl">0.1</span>,alpha_by <span class="op">=</span> <span class="cn">NULL</span>,label <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"cell t"</span><span class="op">)</span></span>
<span><span class="va">cell_dpt_umap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-53-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="clone-weighted-cell-embedding-optional">clone weighted cell embedding (optional)<a class="anchor" aria-label="anchor" href="#clone-weighted-cell-embedding-optional"></a>
</h3>
<p>By integrating information from both the clone embedding and the cell
embedding, we developed a new visualization method called clone-weighted
cell embedding. In this representation, even if two cells are close in
the transcriptomic (cell) embedding, they will be pulled apart in the
clone-weighted embedding if their corresponding clones are distant in
clone space. This embedding can better illustrate the clone level
heterogeneity.</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_k</span> <span class="op">=</span> <span class="fl">30</span></span>
<span><span class="va">clone_k</span> <span class="op">=</span> <span class="fl">15</span></span>
<span><span class="va">cell_embedding</span> <span class="op">=</span> <span class="va">pca</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_clone_prob</span><span class="op">)</span>,<span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></span>
<span><span class="va">coembed_dis</span> <span class="op">=</span> <span class="fu"><a href="../reference/cell_clone_coembed.html">cell_clone_coembed</a></span><span class="op">(</span><span class="va">cell_embedding</span>,<span class="va">clone_embedding</span><span class="op">)</span></span></code></pre></div>
<p>This function <code>cell_clone_coembed</code> would return a sparse
distance matrix, which denotes a weighted kNN network between cells. We
can project this kNN network to UMAP for visulization. This step
requires a python script.</p>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set you python path</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/reticulate/" class="external-link">reticulate</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: package 'reticulate' was built under R version 4.2.1</span></span></code></pre>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/use_python.html" class="external-link">use_python</a></span><span class="op">(</span><span class="st">"~/softwares/anaconda3/envs/py3.8/bin/python"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">script_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"py"</span>, <span class="st">"embedding_from_kNN.py"</span>, package <span class="op">=</span> <span class="st">"Clonotrace"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/source_python.html" class="external-link">source_python</a></span><span class="op">(</span><span class="va">script_path</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rstudio.github.io/reticulate/reference/source_python.html" class="external-link">source_python</a></span><span class="op">(</span><span class="va">script_path</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_coembed_umap</span> <span class="op">=</span> <span class="fu"><a href="../reference/umap_from_knn.html">umap_from_knn</a></span><span class="op">(</span><span class="va">coembed_dis</span>,n_neighbors <span class="op">=</span> <span class="fl">10</span>,seed <span class="op">=</span> <span class="fl">512</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coembed_umap_cluster</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="va">cell_coembed_umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span>,alpha_by <span class="op">=</span> <span class="cn">NULL</span>,label_size <span class="op">=</span> <span class="fl">8</span>,</span>
<span>                          color_by <span class="op">=</span> <span class="st">"cluster"</span>,size <span class="op">=</span> <span class="fl">0.1</span>,alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,    <span class="co"># Remove axis numbers (labels)</span></span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">coembed_umap_cluster</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-60-1.png" width="700"></p>
<p>Obviously, there appear two boundaries within the two branchs for
monocytes (cluster 4, 3, 5) and neutriphils (cluster 1, 6, 7), which
denote the clone level heterogenity. Once we colored cells by the
profile identity, we can see the two boundaries seperate the bipoent and
unipotent profiles.</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coembed_umap_profile</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="va">cell_coembed_umap</span>,annot <span class="op">=</span> <span class="va">cell_meta</span>,alpha_by <span class="op">=</span> <span class="cn">NULL</span>,label_size <span class="op">=</span> <span class="fl">8</span>,</span>
<span>                          color_by <span class="op">=</span> <span class="st">"profile"</span>,size <span class="op">=</span> <span class="fl">0.1</span>,alpha <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,    <span class="co"># Remove axis numbers (labels)</span></span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://satijalab.org/seurat/reference/SeuratTheme.html" class="external-link">NoLegend</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">coembed_umap_profile</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-61-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="profile-enrichment-in-each-cluster">profile enrichment in each cluster<a class="anchor" aria-label="anchor" href="#profile-enrichment-in-each-cluster"></a>
</h3>
<p>In the dowsntream analysis we will focus on the early bipotent
profiles (profile) and detect early fate-associated genes. To achieve
this goal we first do an enrichment test between profiles and clusters
to show in which cluster profile 1 has significant high density. And
then within the target cluster, we compare the gene expression between
profile 1 and other profiles to identify early fate-associated
genes.</p>
<p>We first do the cell cluster profile enrichment using permutation
test:</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">enrich</span> <span class="op">=</span> <span class="fu"><a href="../reference/cluster_profile_enrich.html">cluster_profile_enrich</a></span><span class="op">(</span><span class="va">cell_profile_prob</span>,<span class="va">cell_meta</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_profile_prob</span><span class="op">)</span>,<span class="st">"cluster"</span><span class="op">]</span>,permute_n  <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p>We can then visualize the enrichment result using a heatmap:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mass_long</span> <span class="op">=</span> <span class="fu"><a href="../reference/wide2long.html">wide2long</a></span><span class="op">(</span><span class="va">enrich</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">mass_long</span> <span class="op">=</span> <span class="va">mass_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">enrich</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>                                 j <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">enrich</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mass_long</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cluster"</span>,<span class="st">"profile"</span>,<span class="st">"mass"</span><span class="op">)</span></span>
<span><span class="va">mass_long</span> <span class="op">=</span> <span class="va">mass_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>freq <span class="op">=</span> <span class="va">mass</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">mass</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mass_long</span><span class="op">$</span><span class="va">pvalue</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">enrich</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mass_long</span><span class="op">$</span><span class="va">signif</span> <span class="op">=</span> <span class="st">"ns"</span></span>
<span><span class="va">mass_long</span><span class="op">$</span><span class="va">signif</span><span class="op">[</span><span class="va">mass_long</span><span class="op">$</span><span class="va">pvalue</span><span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">]</span> <span class="op">=</span> <span class="st">"*"</span></span>
<span><span class="va">mass_long</span><span class="op">$</span><span class="va">signif</span><span class="op">[</span><span class="va">mass_long</span><span class="op">$</span><span class="va">pvalue</span><span class="op">&lt;</span> <span class="fl">0.01</span><span class="op">]</span> <span class="op">=</span> <span class="st">"**"</span></span>
<span><span class="va">mass_long</span><span class="op">$</span><span class="va">signif</span><span class="op">[</span><span class="va">mass_long</span><span class="op">$</span><span class="va">pvalue</span><span class="op">&lt;</span> <span class="fl">0.001</span><span class="op">]</span> <span class="op">=</span> <span class="st">"***"</span></span></code></pre></div>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_type_profile_enrich_heatmap</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">mass_long</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cluster</span>,y <span class="op">=</span> <span class="va">profile</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">freq</span><span class="op">)</span>,color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="st">"turbo"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mass_long</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">signif</span> <span class="op">!=</span> <span class="st">"ns"</span><span class="op">)</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">signif</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"cell cluster"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"clone profile"</span><span class="op">)</span></span>
<span><span class="va">cell_type_profile_enrich_heatmap</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-65-1.png" width="700"></p>
<p>From the heatmap we can see that our target profile 1 is enriched in
4 cell clusters, including 1, 3, 4 and 8, within which cluster 1 and 4
are at early differentiation stage. Here, as an example, we will
identify genes differentially expressed in profile 1 in cluter 4.</p>
</div>
<div class="section level3">
<h3 id="profile-deg-within-clusters">profile DEG within clusters<a class="anchor" aria-label="anchor" href="#profile-deg-within-clusters"></a>
</h3>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exprs</span> <span class="op">=</span> <span class="va">seurat_object</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">$</span><span class="va">data</span></span></code></pre></div>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">start</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">DEG_1_4</span> <span class="op">=</span> <span class="fu"><a href="../reference/profile_cluster_DEG.html">profile_cluster_DEG</a></span><span class="op">(</span>profile <span class="op">=</span> <span class="st">"1"</span>,cluster <span class="op">=</span> <span class="st">"4"</span>,exprs <span class="op">=</span> <span class="va">exprs</span>,cell_meta <span class="op">=</span> <span class="va">cell_meta</span>,cell_profile_prob <span class="op">=</span> <span class="va">cell_profile_prob</span><span class="op">)</span></span>
<span><span class="va">end</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">end</span> <span class="op">-</span> <span class="va">start</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Time difference of 3.211435 mins</span></span></code></pre>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DEG_1_4_sig</span> <span class="op">=</span> <span class="va">DEG_1_4</span><span class="op">$</span><span class="va">stat</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">padj</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">DEG_1_4_sig</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2209</span></span></code></pre>
<p>In total we identified 2165 genes which are differentially expressed
in profile 1 in cluster 4.</p>
<p>Here we can take a look at the top 10 genes with the largest effect
size.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">DEG_1_4_sig</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/top_n.html" class="external-link">top_n</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">cohen</span><span class="op">)</span>,n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            stat          pval mean_diff      cohen pcali padj</span></span>
<span><span class="co">## Dmkn   402.8053 1.964458e-157  2.852543  1.2481938     0    0</span></span>
<span><span class="co">## Elane  334.0937 5.498196e-133  3.274804  1.1583383     0    0</span></span>
<span><span class="co">## H2afy  293.6286 3.410286e-118 -6.640054 -1.0967736     0    0</span></span>
<span><span class="co">## Lcn2   372.0014 1.416317e-146  1.686368  1.0552461     0    0</span></span>
<span><span class="co">## Ly6a   286.7642 1.181382e-115 -2.774436 -1.0669486     0    0</span></span>
<span><span class="co">## Mpo    225.6353  1.228477e-92  1.283180  0.9665669     0    0</span></span>
<span><span class="co">## Olfm1  254.4594 1.396541e-103 -1.220302 -0.9769773     0    0</span></span>
<span><span class="co">## Prtn3  263.7946 4.321899e-107  2.336053  1.0213135     0    0</span></span>
<span><span class="co">## S100a8 336.7555 5.993067e-134  9.997585  0.9618319     0    0</span></span>
<span><span class="co">## Wfdc21 596.7888 2.620715e-222  2.947664  1.3916409     0    0</span></span></code></pre>
<p>We can take <code>Dmkn</code> as an example to show how the linear
regression model fits for the profile 1 and other profiles in cluster 4
along pseudotime:</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">test_object</span> <span class="op">=</span> <span class="va">DEG_1_4</span></span></code></pre></div>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">null_fit</span> <span class="op">=</span> <span class="va">test_object</span><span class="op">$</span><span class="va">design_null</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">test_object</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="fl">4</span>,<span class="op">]</span></span>
<span><span class="va">full_fit</span> <span class="op">=</span> <span class="va">test_object</span><span class="op">$</span><span class="va">design_null</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">test_object</span><span class="op">$</span><span class="va">coef</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">null_fit</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">full_fit</span><span class="op">)</span> <span class="op">=</span> <span class="va">test_object</span><span class="op">$</span><span class="va">cell</span></span></code></pre></div>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">example_gene</span> <span class="op">=</span> <span class="st">"Dmkn"</span></span></code></pre></div>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_meta</span><span class="op">$</span><span class="va">exprs</span> <span class="op">=</span> <span class="va">exprs</span><span class="op">[</span><span class="va">example_gene</span>,<span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cell_meta</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cell_meta</span><span class="op">$</span><span class="va">null_exprs</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">cell_meta</span><span class="op">[</span><span class="va">test_object</span><span class="op">$</span><span class="va">cell</span>,<span class="op">]</span><span class="op">$</span><span class="va">null_exprs</span> <span class="op">=</span> <span class="va">null_fit</span><span class="op">[</span>,<span class="va">example_gene</span><span class="op">]</span></span>
<span><span class="va">cell_meta</span><span class="op">$</span><span class="va">full_exprs</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="va">cell_meta</span><span class="op">[</span><span class="va">test_object</span><span class="op">$</span><span class="va">cell</span>,<span class="op">]</span><span class="op">$</span><span class="va">full_exprs</span> <span class="op">=</span> <span class="va">full_fit</span><span class="op">[</span>,<span class="va">example_gene</span><span class="op">]</span></span></code></pre></div>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gene_fit_cluster</span> <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cell_meta</span><span class="op">[</span><span class="va">test_object</span><span class="op">$</span><span class="va">cell</span>,<span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cell_t</span>,y <span class="op">=</span> <span class="va">exprs</span>,fill <span class="op">=</span> <span class="va">cell_profile_prob</span><span class="op">[</span><span class="va">test_object</span><span class="op">$</span><span class="va">cell</span>,<span class="st">"1"</span><span class="op">]</span><span class="op">)</span>,size <span class="op">=</span> <span class="fl">2</span>,shape <span class="op">=</span> <span class="fl">21</span>,color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cell_t</span>,y <span class="op">=</span> <span class="va">null_exprs</span><span class="op">)</span>,color <span class="op">=</span> <span class="st">"steelblue"</span>,linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cell_t</span>,y <span class="op">=</span> <span class="va">full_exprs</span><span class="op">)</span>,color <span class="op">=</span> <span class="st">"coral"</span>,linewidth <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_gradient.html" class="external-link">scale_fill_gradient2</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"profile 1"</span>,low <span class="op">=</span> <span class="st">"steelblue"</span>,mid <span class="op">=</span> <span class="st">"whitesmoke"</span>,high <span class="op">=</span> <span class="st">"coral"</span>,midpoint <span class="op">=</span> <span class="fl">0.5</span>,limit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_classic</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"pseudotime"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">example_gene</span>,<span class="st">"exprs"</span>,sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">gene_fit_cluster</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-75-1.png" width="700"></p>
<p>We can further visualize the expression for <code>Dmkn</code> over
the cell UMAP:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">feature_scatter</span> <span class="op">=</span> <span class="fu"><a href="../reference/dimplot.html">dimplot</a></span><span class="op">(</span>embedding <span class="op">=</span> <span class="va">umap</span>,annot <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">exprs</span><span class="op">)</span>,color_by <span class="op">=</span> <span class="va">example_gene</span>,label  <span class="op">=</span> <span class="cn">FALSE</span>,size <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_color_viridis_c</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span>,option <span class="op">=</span> <span class="st">"plasma"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,    <span class="co"># Remove axis numbers (labels)</span></span>
<span>      axis.ticks <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      plot.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>      legend.position <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="va">example_gene</span><span class="op">)</span><span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"UMAP 1"</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"UMAP 2"</span><span class="op">)</span></span>
<span><span class="va">feature_scatter</span></span></code></pre></div>
<p><img src="Clonotrace_files/figure-html/unnamed-chunk-76-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Yuntian Fu.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
